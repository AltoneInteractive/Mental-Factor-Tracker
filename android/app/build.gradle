apply plugin: "com.android.application"
apply plugin: "com.facebook.react"

react {

}

def enableProguardInReleaseBuilds = false

android {
    ndkVersion rootProject.ext.ndkVersion
    compileSdkVersion rootProject.ext.compileSdkVersion
    namespace "com.mentalfactortracker"

    defaultConfig {
        applicationId "com.mentalfactortracker"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"
    }

    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        release {
            // Priority order: CI env vars > keystore.properties > debug.keystore fallback
            if (System.getenv('KEYSTORE_FILE')) {
                // GitHub Actions / CI environment with release keystore
                println("✓ Using release signing from CI environment variables")
                storeFile file(System.getenv('KEYSTORE_FILE'))
                storePassword System.getenv('KEYSTORE_PASSWORD')
                keyAlias System.getenv('KEY_ALIAS')
                keyPassword System.getenv('KEY_PASSWORD')
            } else {
                def keystorePropertiesFile = rootProject.file("keystore.properties")
                if (keystorePropertiesFile.exists()) {
                    // Local development with keystore.properties
                    println("✓ Using release signing from keystore.properties")
                    def keystoreProperties = new Properties()
                    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))

                    storeFile file(keystoreProperties['storeFile'])
                    storePassword keystoreProperties['storePassword']
                    keyAlias keystoreProperties['keyAlias']
                    keyPassword keystoreProperties['keyPassword']
                } else {
                    // Fall back to debug keystore for development/testing
                    println("⚠ Using DEBUG signing for release build (testing only - not for production!)")
                    storeFile file('debug.keystore')
                    storePassword 'android'
                    keyAlias 'androiddebugkey'
                    keyPassword 'android'
                }
            }
        }
    }

    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            signingConfig signingConfigs.release
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
}

dependencies {
    implementation("com.facebook.react:react-android")
    implementation("com.facebook.react:hermes-android")
}

// Safely apply React Native CLI native modules integration. In some CI runs node_modules may be missing
// or the helper function may not be available; guard to avoid Gradle evaluation failures.

def nativeModulesFile = file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle")
if (nativeModulesFile.exists()) {
    apply from: nativeModulesFile
    try {
        applyNativeModulesAppBuildGradle(project)
    } catch (Throwable t) {
        println("Warning: applyNativeModulesAppBuildGradle() failed: " + t.getMessage())
    }
} else {
    println("Warning: native_modules.gradle not found at " + nativeModulesFile)
}
